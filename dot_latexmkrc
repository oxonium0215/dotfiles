# Global LaTeX Mk configuration for LuaLaTeX with Japanese support
$pdf_mode = 4;  # Use lualatex
$postscript_mode = 0;
$dvi_mode = 0;

# Default LuaLaTeX command
$lualatex = 'lualatex -synctex=1 -interaction=nonstopmode -file-line-error -halt-on-error %O %S';

# Use biber for bibliography
$biber = 'biber %O --bblencoding=utf8 -u -U --output_safechars %B';
$bibtex_use = 2;

# Default directory settings (can be overridden by project-specific config)
$aux_dir = 'aux';
$out_dir = 'out';

# Clean up settings
$clean_ext = 'auxlock figlist makefile run.xml synctex.gz fls fdb_latexmk idx ind ilg glo gls glg nav snm vrb bak sav fmt';

# Preview settings
$preview_continuous_mode = 1;
$sleep_time = 1;
$max_repeat = 3;

# Font settings for various systems
if (-d '/mnt/c/Windows/Fonts') {
    $ENV{'OSFONTDIR'} = '/mnt/c/Windows/Fonts:/usr/local/share/fonts:/usr/share/fonts:/System/Library/Fonts';
} else {
    $ENV{'OSFONTDIR'} = '/usr/local/share/fonts:/usr/share/fonts:/System/Library/Fonts';
}

# LuaTeX optimizations
$ENV{'TEXMFCACHE'} = $ENV{HOME} . '/.cache/luatex';
$warnings_as_errors = 0;
$ENV{'LANG'} = 'C.UTF-8';
$ENV{'LC_ALL'} = 'C.UTF-8';
$ENV{'max_print_line'} = '10000';
$ENV{'error_line'} = '254';
$ENV{'half_error_line'} = '238';
$ENV{'LUATEX_COMPILE_TIME'} = '1';

# Global format file support
sub check_global_format {
    my $home = $ENV{HOME};
    my $fmt_file = "$home/lualatex-myformat.fmt";
    return (-e $fmt_file) ? $fmt_file : undef;
}

my $global_fmt = check_global_format();
if ($global_fmt) {
    my $home = $ENV{HOME};
    $lualatex = "lualatex -fmt=$home/lualatex-myformat -synctex=1 -interaction=nonstopmode -file-line-error -halt-on-error %O %S";
    print "Using global LuaLaTeX format file: $global_fmt\n";
}

# Standard dependency tracking
add_cus_dep('glo', 'gls', 0, 'run_makeglossaries');
add_cus_dep('acn', 'acr', 0, 'run_makeglossaries');
add_cus_dep('alg', 'glg', 0, 'run_makeglossaries');

sub run_makeglossaries {
    my ($base_name, $path) = fileparse($_[0]);
    return system "makeglossaries", $base_name;
}
