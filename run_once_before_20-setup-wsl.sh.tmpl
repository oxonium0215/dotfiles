#!/bin/bash
# WSL-specific setup
# This script runs once before chezmoi applies the dotfiles (only on WSL)

{{- $isWSL := false -}}
{{- if hasKey .chezmoi "kernel" -}}
{{-   if hasKey .chezmoi.kernel "osrelease" -}}
{{-     $isWSL = contains "microsoft" (lower .chezmoi.kernel.osrelease) -}}
{{-   end -}}
{{- end -}}
{{ if and (eq .chezmoi.os "linux") $isWSL }}
set -euo pipefail

echo "==> Setting up WSL-specific configurations..."

# Install npiperelay for SSH Agent forwarding from Windows
# This allows using Bitwarden SSH Agent from WSL
NPIPERELAY_VERSION="v0.1.0"
NPIPERELAY_DIR="$HOME/.local/bin"

if ! command -v npiperelay.exe &>/dev/null; then
    echo "Installing npiperelay for SSH Agent forwarding..."
    
    mkdir -p "$NPIPERELAY_DIR"
    
    # Download npiperelay
    TEMP_DIR=$(mktemp -d)
    curl -fsSL "https://github.com/jstarks/npiperelay/releases/download/${NPIPERELAY_VERSION}/npiperelay_windows_amd64.zip" -o "$TEMP_DIR/npiperelay.zip"
    
    # Extract and install
    unzip -q "$TEMP_DIR/npiperelay.zip" -d "$TEMP_DIR"
    mv "$TEMP_DIR/npiperelay.exe" "$NPIPERELAY_DIR/"
    chmod +x "$NPIPERELAY_DIR/npiperelay.exe"
    
    rm -rf "$TEMP_DIR"
    echo "npiperelay installed to $NPIPERELAY_DIR/npiperelay.exe"
fi

# Ensure socat is installed (required for SSH Agent forwarding)
if ! command -v socat &>/dev/null; then
    echo "Warning: socat is not installed. SSH Agent forwarding will not work."
    echo "Please install socat: sudo apt-get install socat"
fi

echo "==> WSL setup completed."

{{ else -}}
# Not WSL, skip this script
exit 0
{{ end -}}
